import{_ as ae,r,h as le,o as oe,c as w,w as n,a as d,d as i,b as o,Q as c,f,g as E,F,j as te,k as ne,i as se,t as _,p as re,q,l as ie,n as S}from"./index-B-wX8S5p.js";import{Q as h,a as M,b as N,c as ue}from"./QTable-DsPkTBfg.js";import{b as de,a as T,Q as x}from"./QPage-5EFWhCc5.js";import{u as ce,g as U,a as me,Q as v,b as D,p as fe}from"./useAuth-B1U9RWE7.js";import{Q as ve,a as pe,b as be,C as ge}from"./ClosePopup-DK3yPYJs.js";const ye={key:0,style:{color:"green"}},we={key:1,style:{color:"red"}},Ve={class:"text-center text-weight-bold"},ke={class:"row q-col-gutter-lg"},Ce={class:"col-12 col-md-6"},_e={class:"col-12 col-md-6"},he={class:"text-center"},xe={__name:"Entradas",setup(Qe){const Q=r([]),p=r([]),t=r({tipo:2,numeroFactura:"",fecha:"",articulos:[],subtotal:0,iva:19,total:0,estado:1}),V=r(null),b=r(!1),u=r(!1),A=r(null),m=r(!1),z=r(null);let B=r(!0);const $=ce(),g=r(!1),k=r(null),C=r(!1),L=[{name:"numeroFactura",label:"Número Factura",align:"center",field:"numeroFactura"},{name:"cliente",label:"Cliente",align:"center",field:"cliente"},{name:"fecha",label:"Fecha",align:"center",field:"fecha",format:l=>new Date(l).toLocaleDateString()},{name:"total",label:"Total",align:"center",field:"total"},{name:"estado",label:"Estado",align:"center",field:"estado",format:l=>l===1?"Aprobado":"Anulado"},{name:"opciones",label:"Opciones",align:"center"}],I=[{name:"nombre",label:"Artículo",field:"nombre",align:"center"},{name:"cantidad",label:"Cantidad",field:"cantidad",align:"center"},{name:"precio",label:"Precio",field:"precio",align:"center"},{name:"subtotal",label:"Subtotal",field:l=>l.cantidad*l.precio,align:"center"},{name:"opciones",label:"Opciones",align:"center"}];async function R(){const l=$.getToken();if(console.log("Token recuperado del store",l),!l){console.log("Token no encontrado");return}try{const e=await U("movimientos/ventas");e&&Array.isArray(e)?Q.value=e:console.log("La respuesta no contiene los datos esperados")}catch(e){console.log("Error al obtener los datos:",e.response?e.response.data:e)}}function O(){K(),m.value=!0}function P(l){if(!l)return;const e=p.value.find(a=>a._id===l);e&&!t.value.articulos.some(a=>a.id===l)&&t.value.articulos.push({id:e._id,nombre:e.nombre,cantidad:1,precio:e.precio||0}),y()}function j(l){t.value.articulos=t.value.articulos.filter(e=>e.id!==l),y()}function y(){const l=t.value.articulos.reduce((a,s)=>a+s.cantidad*s.precio,0),e=l*t.value.iva/100;t.value.subtotal=l,t.value.total=l+e}le(()=>t.value.articulos,()=>y(),{deep:!0});async function G(){p.value=await U("articulos")}function H(l){b.value=!0,u.value=!1,A.value=l._id,t.value={...l},m.value=!0}function J(l){console.log("viewMovimiento",l),b.value=!1,u.value=!0,t.value={...l},m.value=!0,l.articulos&&Array.isArray(l.articulos)?(cliente.value=l.cliente,fecha.value=l.fecha,numeroFactura.value=l.numeroFactura,p.value=l.articulos.map(e=>(console.log("articuloFactura",e),{id:e._id,nombre:e._id.nombre,precio:e._id.precio,cantidad:e.cantidad,iva:e._id.iva||19})),console.log("articulos con iva",p.value)):(console.error("La propiedad 'productos' no está definida o no es un arreglo"),Notify.create({message:"Error: No se encontraron productos en la factura.",color:"red",icon:"error",position:"top",timeout:3e3}))}function K(){t.value={tipo:2,numeroFactura:"",fecha:"",articulos:[],subtotal:0,iva:16,total:0,estado:1},b.value=!1,u.value=!1,V.value=null}function W(){m.value=!1}async function X(){b.value?await D(`movimientos/${A.value}`,t.value):await fe("movimientos",t.value),fetchMovimientos(),m.value=!1}oe(()=>{R(),G()});const Y=async l=>{k.value=l,g.value=!0},Z=async()=>{if(C.value=!0,!k.value)return;const l=k.value;l.estado=l.estado===1?0:1;try{const e=await D(`movimientos/${l._id}`,{estado:l.estado});console.log("Estado actualizado con éxito:",e),Notify.create({message:"Estado actualizado con éxito",color:"green",icon:"check_circle",position:"top",timeout:3e3}),await getClientes(),g.value=!1}catch(e){console.log("Error al actualizar el estado:",e.response?e.response.data:e),Notify.create({message:"Error al actualizar el estado",color:"red",icon:"error",position:"top",timeout:3e3})}finally{C.value=!1}},ee=()=>{g.value=!1};return(l,e)=>(d(),w(de,{padding:""},{default:n(()=>[e[11]||(e[11]=i("h4",{class:"text-center text-weight-bold"},"Ventas",-1)),e[12]||(e[12]=i("hr",null,null,-1)),o(c,{label:"Registrar",icon:"add",class:"q-mb-md",onClick:O}),o(M,{rows:Q.value,columns:L,"row-key":"_id",bordered:"",flat:"",class:"tabla-views"},{header:n(a=>[i("tr",null,[(d(!0),f(F,null,E(a.cols,s=>(d(),f("th",{key:s.name,class:S("tabla-header")},[i("span",null,_(s.label),1)]))),128))])]),"body-cell-estado":n(a=>[o(h,{props:a,class:"q-pa-sm"},{default:n(()=>[a.row.estado==1?(d(),f("span",ye,"Aprobado")):(d(),f("span",we,"Anulado"))]),_:2},1032,["props"])]),"body-cell-opciones":n(a=>[o(h,{props:a,class:"tabla-cell opciones"},{default:n(()=>[o(c,{flat:"",color:"primary",icon:"visibility",onClick:s=>J(a.row),class:"q-mr-sm"},null,8,["onClick"]),o(c,{flat:"",color:"primary",icon:"edit",onClick:s=>H(a.row),class:"q-mr-sm"},null,8,["onClick"]),o(c,{icon:a.row.estado===1?"remove_circle":"check_circle",color:a.row.estado===1?"negative":"positive",flat:"",onClick:s=>Y(a.row)},null,8,["icon","color","onClick"])]),_:2},1032,["props"])]),_:1},8,["rows"]),o(N,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=a=>g.value=a)},{default:n(()=>[o(T,null,{default:n(()=>[e[8]||(e[8]=i("div",{class:"text-h6"},"¿Estás seguro de cambiar el estado?",-1)),o(x),o(me,null,{default:n(()=>[o(c,{label:"Cancelar",color:"secondary",flat:"",onClick:ee}),o(c,{label:"Confirmar",loading:C.value,color:"primary",flat:"",onClick:Z},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(N,{modelValue:m.value,"onUpdate:modelValue":e[7]||(e[7]=a=>m.value=a),persistent:"",maximized:ie(B),"transition-show":"slide-up","transition-hide":"slide-down"},{default:n(()=>[o(T,{class:"text-dark"},{default:n(()=>[o(ve,{class:"q-pa-lg"},{default:n(()=>[o(te),ne((d(),w(c,{dense:"",flat:"",icon:"close"},{default:n(()=>[o(pe,{class:"bg-white text-primary"},{default:n(()=>e[9]||(e[9]=[se("Cerrar")])),_:1})]),_:1})),[[ge]])]),_:1}),o(x,null,{default:n(()=>[i("h4",Ve,_(b.value?"Editar Factura":u.value?"Detalle Factura":"Registrar Nueva Factura"),1),e[10]||(e[10]=i("hr",null,null,-1))]),_:1}),o(x,{class:"tabla-views"},{default:n(()=>[o(be,{onSubmit:re(X,["prevent"]),ref_key:"formRef",ref:z},{default:n(()=>[i("div",ke,[i("div",Ce,[o(v,{modelValue:t.value.numeroFactura,"onUpdate:modelValue":e[1]||(e[1]=a=>t.value.numeroFactura=a),label:"Número de Factura",filled:"",type:"text",rules:[a=>!!a||"El número de factura es obligatorio"],class:"q-mb-sm",readonly:u.value},null,8,["modelValue","rules","readonly"]),o(v,{modelValue:t.value.fecha,"onUpdate:modelValue":e[2]||(e[2]=a=>t.value.fecha=a),label:"Fecha",type:"date",filled:"",rules:[a=>!!a||"La fecha es obligatoria"],class:"q-mb-sm",readonly:u.value},null,8,["modelValue","rules","readonly"]),o(ue,{modelValue:V.value,"onUpdate:modelValue":[e[3]||(e[3]=a=>V.value=a),P],label:"Seleccionar Artículo",options:p.value,"option-value":"_id","option-label":"nombre",filled:"","emit-value":"",class:"q-mb-sm"},null,8,["modelValue","options"])]),i("div",_e,[o(v,{modelValue:t.value.subtotal,"onUpdate:modelValue":e[4]||(e[4]=a=>t.value.subtotal=a),modelModifiers:{number:!0},label:"Valor Subtotal",filled:"",type:"number",readonly:!0,class:"q-mb-sm"},null,8,["modelValue"]),o(v,{modelValue:t.value.iva,"onUpdate:modelValue":e[5]||(e[5]=a=>t.value.iva=a),modelModifiers:{number:!0},label:"IVA (%)",filled:"",type:"number",class:"q-mb-sm",readonly:u.value,onInput:y},null,8,["modelValue","readonly"]),o(v,{modelValue:t.value.total,"onUpdate:modelValue":e[6]||(e[6]=a=>t.value.total=a),modelModifiers:{number:!0},label:"Total",filled:"",type:"number",readonly:!0,class:"q-mb-sm"},null,8,["modelValue"])])]),o(M,{rows:t.value.articulos,columns:I,"row-key":"id",flat:"",bordered:"",class:"tabla-views"},{header:n(a=>[i("tr",null,[(d(!0),f(F,null,E(a.cols,s=>(d(),f("th",{key:s.name,class:S("tabla-header")},[i("span",null,_(s.label),1)]))),128))])]),"body-cell-cantidad":n(a=>[o(v,{modelValue:a.row.cantidad,"onUpdate:modelValue":s=>a.row.cantidad=s,modelModifiers:{number:!0},type:"number",dense:"",filled:"",readonly:u.value,onInput:y},null,8,["modelValue","onUpdate:modelValue","readonly"])]),"body-cell-opciones":n(a=>[o(h,{props:a,class:"tabla-cell opciones"},{default:n(()=>[u.value?q("",!0):(d(),w(c,{key:0,flat:"",color:"negative",icon:"delete",onClick:s=>j(a.row.id)},null,8,["onClick"]))]),_:2},1032,["props"])]),_:1},8,["rows"]),i("div",he,[u.value?q("",!0):(d(),w(c,{key:0,color:"primary",label:"Guardar",type:"submit",class:"q-mr-sm"})),o(c,{label:"Cancelar",color:"negative",flat:"",onClick:W})])]),_:1},512)]),_:1})]),_:1})]),_:1},8,["modelValue","maximized"])]),_:1}))}},Me=ae(xe,[["__scopeId","data-v-aa9e0389"]]);export{Me as default};
